Vagrant.configure("2") do |config|

  common = <<-SCRIPT
  sudo parted /dev/sda resizepart 2 100%
  sudo pvresize /dev/sda2
  sudo lvextend -l +100%FREE /dev/centos/root
  sudo xfs_growfs /dev/centos/root
  SCRIPT

  config.disksize.size = "100GB"
  config.ssh.insert_key = false

  config.vm.define "centos-name" do |hopsworks|
     hopsworks.vm.box = "bento/centos-7.7"
     hopsworks.vm.hostname = 'hopsworks0.logicalclocks.com'
     hopsworks.vm.boot_timeout = 3600
     # Mount .m2 directory for maven cache
     hopsworks.vm.synced_folder "m2", "/root/.m2", create: true
     # Mount output directory
     hopsworks.vm.synced_folder "out", "/home/vagrant/test_report", create: true

     hopsworks.vm.network :forwarded_port, guest: 22, host: 10022, id: "ssh"
     # karamel http
     hopsworks.vm.network(:forwarded_port, {:guest=>9090, :host=>9090})
     # Hopsworks http
     hopsworks.vm.network(:forwarded_port, {:guest=>8181, :host=>8181})
     # Glassfish admin UI
     hopsworks.vm.network(:forwarded_port, {:guest=>4848, :host=>4848})
     # MySQL Server
     hopsworks.vm.network(:forwarded_port, {:guest=>3306, :host=>3306})
     # Glassfish debug port
     hopsworks.vm.network(:forwarded_port, {:guest=>9009, :host=>9009})
     # GDB Remote debug port
     hopsworks.vm.network(:forwarded_port, {:guest=>12345, :host=>12345})

     hopsworks.vm.provision "file", source: "cluster.yml", destination: "cluster.yml"
     hopsworks.vm.provision "file", source: "~/.vagrant.d/insecure_private_key", destination: "~/.ssh/id_rsa"
     hopsworks.vm.provision "shell", inline: "cp /home/vagrant/.ssh/authorized_keys /home/vagrant/.ssh/id_rsa.pub && sudo chown vagrant:vagrant /home/vagrant/.ssh/id_rsa.pub"

     hopsworks.vm.provider :virtualbox do |v|
       v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
       v.customize ["modifyvm", :id, "--memory", 30748]
       v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
       v.customize ["modifyvm", :id, "--nictype1", "virtio"]
       v.customize ["modifyvm", :id, "--name", "centos-name"]
       v.customize ["modifyvm", :id, "--cpus", "10"]
     end

     config.vm.provision :shell, :inline => common
     
     hopsworks.vm.provision :chef_solo do |chef|
         chef.version = "14.10.9"
         chef.cookbooks_path = "cookbooks"
         chef.json = {
           "karamel" => {
             "default" =>      {
                     "private_ips" => ["10.0.2.15"]
             }
           }
         }
         chef.add_recipe "karamel::install"
         chef.add_recipe "karamel::default"
         chef.add_recipe "karamel::run"
     end
    end
end
